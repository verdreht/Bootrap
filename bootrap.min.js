let $$ = document.querySelectorAll.bind(document);

let wrap = function (toWrap, wrapper) {
    wrapper = wrapper || document.createElement('div');
    toWrap.parentNode.appendChild(wrapper);
    return wrapper.appendChild(toWrap);
};

//Bootrap initializer
window.addEventListener("load", function () {
    for (const elem of $$(".form-control")) {

        if(elem.getAttribute("type").toLowerCase() !== "checkbox") {

            let parent = elem.parentNode;
            let span = document.createElement("div");
            span.classList.add("text-border-bottom");
            parent.appendChild(span);

            elem.addEventListener("focus", function () {
                let color = "black"
                if(elem.classList.contains("invalid")) {
                    color = "red";
                }
                elem.nextElementSibling.style.width = "0";
                $(elem.nextElementSibling).stop().animate({
                    "background-color": color,
                    "height": "2px",
                    "width": "100%",
                }, 200);
            });
            elem.addEventListener("blur", function () {
                if(!elem.classList.contains("invalid")) {
                    $(elem.nextElementSibling).stop().animate({
                        "height": "1px",
                        "background-color": "#dbdbdb",
                    }, 200);
                }
            });
        }
    }
    for(const elem of $$(".form-control-button")) {
        elem.addEventListener("click", function () {
            if(!elem.innerHTML.includes("spinner")) {
                elem.innerHTML = "<span class=\"spinner-border spinner-border-sm\" role=\"status\" aria-hidden=\"true\"></span> Loading...";
            } else {
                $(elem).effect("shake");
            }
            setTimeout(function () {
                elem.blur();
            }, 200);
        })
    }
})

let validateAll = function() {

    let passed = true;

    for(const elem of $$(".form-control")) {
        if(elem.tagName === "INPUT") {
            if(elem.getAttribute("required") !== null) {
                if(!validate(elem)) {
                    passed = false;
                }
            }
        }
    }

    return passed;
}


let validate = function (element, newValue = "") {

    let elemType = element.getAttribute("type").toLowerCase();

    if(elemType === "text") {
        if(newValue === "") {
            if(element.value !== "") {
                __hideError(element);
                return true;
            }

        } else {
            __hideError(element);
            return true;
        }
    } else if(elemType === "number") {
        let min = element.getAttribute("min");
        let max = element.getAttribute("max");

        if(min === null) {
            min = 0;
        }
        if(max === null) {
            max = 100;
        }

        if(newValue === "") {
            if(element.value !== "") {
                if(Number(element.value) <= Number(max) && Number(element.value) >= Number(min)) {
                    __hideError(element);
                    return true;
                }
            }
        } else {
            if(Number(newValue) <= Number(max) && Number(newValue) >= Number(min)) {
                __hideError(element);
                return true;
            }
        }
    } else if(elemType === "email") {
        if(newValue === "") {
            if(element.value !== "") {
                if(validateEmail(element.value)) {
                    __hideError(element);
                    return true;
                }
            }

        } else {
            if(validateEmail(newValue)) {
                __hideError(element);
                return true;
            }
        }
    } else if(elemType === "password") {
        let minLength = element.getAttribute("minlength");
        if(newValue === "") {
            if(element.value !== "") {
                if(minLength == null) {
                    __hideError(element);
                    return true;
                }
                if(element.value.length >= Number(minLength)) {
                    __hideError(element);
                    return true;
                }
            }

        } else {
            if(minLength == null) {
                __hideError(element);
                return true;
            }
            if(newValue.length >= Number(minLength)) {
                __hideError(element);
                return true;
            }
        }
    }


    __showError(element);
    return false;

}

function validateEmail(email) {
    const re = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
    return re.test(email);
}

function __hideError(element) {
    $(element.nextElementSibling).stop().animate({
        "height": "1px",
        "background-color": "#dbdbdb",
    }, 200);
    element.classList.remove("invalid");
}

function __showError(element) {
    $(element.nextElementSibling).stop().animate({
        "background-color": "red",
        "height": "2px",
        "width": "100%",
    }, 200);
    element.classList.add("invalid");

    let events = $._data(element, "events");

    if(events == null) {
        $(element).on('keypress.validation', function (event) {
            let newValue = event.target.value + getKey(event);
            if(newValue !== "") {
                $(this).off('keypress.validation')
                validate(event.target, newValue);
            }

        });
    }

}

function getKey(e){
    let keynum;

    if(window.event) { // IE
        keynum = e.keyCode;
    } else if(e.which){ // Netscape/Firefox/Opera
        keynum = e.which;
    }

    return(String.fromCharCode(keynum));
}